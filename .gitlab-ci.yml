stages:
- build
- deploy

build:
  stage: build
  image: maven:3.3.3-jdk-8
  artifacts:
    expire_in: 1h
    paths:
    - target/*.jar
  script:
  - mvn package -q
  - ARTIFACT=$(find target -name "moneytracker-*.jar" | tr -d '[[:space:]]')
  - "export sha1=$(sha1sum $ARTIFACT | awk '{print $1}')"
  - "export md5=$(md5sum $ARTIFACT | awk '{print $1}')"
  - ARTIFACT_NAME=${ARTIFACT#"target/"}
  - curl -f --user $ARTIFACTORY_USER:$ARTIFACTORY_PASSWORD --data-binary "@$ARTIFACT" -X PUT "https://artifactory.stritzke.me/artifactory/money-tracker/$ARTIFACT_NAME" -H "X-Checksum-Sha1:$sha1" -H "X-Checksum-Md5:$md5"

deploy:
  stage: deploy
  image: dstritzke/docker-ansible:2.0.2.0
  dependencies:
  - build
  script:
  - mkdir ~/.ssh
  - echo "$ID_RSA" > ~/.ssh/id_rsa
  - chmod 0600 ~/.ssh/id_rsa
  - echo "$KNOWN_HOSTS" > ~/.ssh/known_hosts
  - chmod 0600 ~/.ssh/known_hosts
  - eval "$(ssh-agent -s)"
  - ssh-add ~/.ssh/id_rsa
  - ansible-playbook -i hosts create.yml --extra-vars "jar=$(find target/ -type f -name "*.jar" -printf "%f\n")"